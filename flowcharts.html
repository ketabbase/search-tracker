<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SearchTracker Algorithm Flowcharts</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        h2 {
            color: #444;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
            margin-top: 40px;
            page-break-before: always;
        }
        .flowchart-container {
            background-color: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            page-break-inside: avoid;
        }
        .mermaid {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        @media print {
            body {
                background-color: white;
            }
            .flowchart-container {
                page-break-after: always;
                box-shadow: none;
            }
            h2 {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <h1>SearchTracker Algorithm Flowcharts</h1>

    <div class="flowchart-container">
        <h2>1. Main Program Flow</h2>
        <div class="mermaid">
flowchart TD
    A[Start Program] --> B[Initialize SearchTracker]
    B --> C[Create Timestamped Data Directory]
    C --> D[Setup CSV Files with Headers]
    D --> E[Initialize Tracking Variables]
    E --> F[Register Signal Handler]
    F --> G[Start Browser]
    
    G --> H{Browser Started<br/>Successfully?}
    H -->|No| I[Print Error Message]
    I --> Z[End Program]
    
    H -->|Yes| J[Print Instructions to User]
    J --> K[Enter Main Tracking Loop]
    
    K --> L{is_running<br/>= True?}
    L -->|No| M[Cleanup]
    M --> Z
    
    L -->|Yes| N[Sleep 1 Second]
    N --> O[Check New Windows]
    O --> P[Get Current Window Handle]
    P --> Q[Get Current URL]
    Q --> R{URL Changed?}
    R -->|Yes| S[Record URL Change]
    R -->|No| T[Record Scroll]
    S --> T
    T --> U[Extract Query from URL]
    U --> V{Query Found<br/>and New?}
    V -->|Yes| W[Save Search Query]
    V -->|No| L
    W --> L
    
    K -.->|Ctrl+C| X[KeyboardInterrupt]
    K -.->|Error| Y[Exception Handler]
    X --> M
    Y --> M
        </div>
    </div>

    <div class="flowchart-container">
        <h2>2. Browser Startup Flow</h2>
        <div class="mermaid">
flowchart TD
    A[Start Browser] --> B[Cleanup Old Chrome Profile]
    B --> C[Terminate Existing Chrome Processes]
    C --> D{Platform}
    D -->|Windows| E[taskkill chrome.exe]
    D -->|Linux/Mac| F[pkill chrome]
    E --> G[Wait 3 Seconds]
    F --> G
    G --> H[Configure Chrome Options]
    H --> I[Create Temp Profile Directory]
    I --> J[Initialize WebDriver]
    J --> K[Navigate to Google]
    
    K --> L{Navigation<br/>Success?}
    L -->|No| M{Retries < 3?}
    M -->|Yes| N[Wait 5 Seconds]
    N --> K
    M -->|No| O[Return Failure]
    
    L -->|Yes| P[Store Original Window Handle]
    P --> Q[Record Initial URL]
    Q --> R[Set URL Start Time]
    R --> S[Return Success]
        </div>
    </div>

    <div class="flowchart-container">
        <h2>3. Main Tracking Loop Detail</h2>
        <div class="mermaid">
flowchart TD
    A[Main Tracking Loop] --> B[Sleep 1 Second]
    B --> C[Check New Windows]
    C --> D[Get Current Window Handle]
    D --> E[Get Current URL]
    E --> F{Window Handle<br/>in last_urls?}
    
    F -->|No| G[Record URL Change]
    F -->|Yes| H{URL Changed?}
    H -->|Yes| G
    H -->|No| I[Record Scroll]
    
    G --> I
    I --> J[Extract Query from URL]
    J --> K{Query Exists<br/>AND Different?}
    K -->|Yes| L[Save Search Query]
    K -->|No| M{is_running?}
    L --> M
    
    M -->|True| B
    M -->|False| N[Exit Loop]
    N --> O[Cleanup]
        </div>
    </div>

    <div class="flowchart-container">
        <h2>4. Window Management Flow</h2>
        <div class="mermaid">
flowchart TD
    A[Check New Windows] --> B[Get Current Window Handles]
    B --> C[Get User Active Handle]
    C --> D[Find Closed Handles]
    D --> E{Closed<br/>Handles<br/>Exist?}
    
    E -->|Yes| F[For Each Closed Handle]
    F --> G[Update navigation_links.csv<br/>Set close_timestamp]
    G --> H[Record Final Duration]
    H --> I[Remove from last_urls]
    I --> J[Remove from recorded_windows]
    J --> K{More Closed<br/>Handles?}
    K -->|Yes| F
    K -->|No| L[Find New Handles]
    
    E -->|No| L
    
    L --> M{New<br/>Handles<br/>Exist?}
    M -->|Yes| N[For Each New Handle]
    N --> O[Switch to New Window]
    O --> P[Get Initial URL]
    P --> Q[Record New Tab Initial URL]
    Q --> R[Add to recorded_windows]
    R --> S{More New<br/>Handles?}
    S -->|Yes| N
    S -->|No| T[Restore User Active Window]
    
    M -->|No| T
    T --> U[Return]
        </div>
    </div>

    <div class="flowchart-container">
        <h2>5. URL Change Tracking Flow</h2>
        <div class="mermaid">
flowchart TD
    A[Record URL Change] --> B{Previous URL<br/>Exists?}
    
    B -->|Yes| C[Get Previous URL]
    C --> D{Previous URL in<br/>url_start_times?}
    D -->|Yes| E[Calculate Duration]
    E --> F{Duration ><br/>1 Second?}
    F -->|Yes| G[Write to url_durations.csv]
    F -->|No| H[Read navigation_links.csv]
    G --> H
    
    D -->|No| H
    
    H --> I[Find Row with Previous URL<br/>and Empty close_timestamp]
    I --> J[Set close_timestamp]
    J --> K[Write Updated CSV]
    K --> L[Record New URL]
    
    B -->|No| L
    
    L --> M[Append to navigation_links.csv<br/>with open_timestamp]
    M --> N[Update last_urls]
    N --> O[Set url_start_times]
    O --> P[Return]
        </div>
    </div>

    <div class="flowchart-container">
        <h2>6. Scroll Detection Flow</h2>
        <div class="mermaid">
flowchart TD
    A[Record Scroll] --> B[Execute JavaScript:<br/>window.pageYOffset]
    B --> C[Get Current Position]
    C --> D{Window Handle in<br/>last_scroll_position?}
    
    D -->|Yes| E[Get Last Position]
    E --> F[Calculate Scroll Distance]
    F --> G{abs(scroll_distance)<br/>> 10 pixels?}
    
    G -->|Yes| H[Write to scrolls.csv:<br/>timestamp, distance, URL]
    G -->|No| I[Update last_scroll_position]
    H --> I
    
    D -->|No| I
    
    I --> J[Return]
        </div>
    </div>

    <div class="flowchart-container">
        <h2>7. Query Extraction Flow</h2>
        <div class="mermaid">
flowchart TD
    A[Extract Query from URL] --> B[Find 'q=' in URL]
    B --> C{'q=' Found?}
    
    C -->|No| D[Return None]
    
    C -->|Yes| E[Find '&sca' After 'q=']
    E --> F{'&sca' Found?}
    
    F -->|No| D
    
    F -->|Yes| G[Extract Encoded Query<br/>Between 'q=' and '&sca']
    G --> H[URL Decode Query]
    H --> I[Return Decoded Query]
        </div>
    </div>

    <div class="flowchart-container">
        <h2>8. Cleanup Flow</h2>
        <div class="mermaid">
flowchart TD
    A[Cleanup] --> B[Save Final Data and Cleanup]
    B --> C[For Each URL in url_start_times]
    C --> D[Calculate Final Duration]
    D --> E{Duration ><br/>1 Second?}
    E -->|Yes| F[Write to url_durations.csv]
    E -->|No| G{More URLs?}
    F --> G
    
    G -->|Yes| C
    G -->|No| H{Driver Exists?}
    
    H -->|Yes| I[driver.quit]
    H -->|No| J{Temp Profile<br/>Dir Exists?}
    I --> J
    
    J -->|Yes| K[Delete Temp Profile Directory]
    J -->|No| L[Terminate Remaining<br/>Chrome Processes]
    K --> L
    L --> M[Return]
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>

